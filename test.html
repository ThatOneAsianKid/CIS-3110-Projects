<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #212529;
            color: #f8f9fa;
        }
        .card {
            background-color: #343a40;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4 text-light">Analytics Dashboard</h1>
        <div class="row">
            <!-- Daily Active Players Chart -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Daily Active Players</h5>
                        <canvas id="dailyActivePlayersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <!-- Ad Engagement Funnel and Platform Avg Time Chart -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Ad Engagement Funnel</h5>
                        <canvas id="adFunnelChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Platform Avg Time Chart</h5>
                        <canvas id="platformTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <!-- Two smaller charts for categorical data -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Feedback Chart</h5>
                        <canvas id="feedbackChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Player Region Chart</h5>
                        <canvas id="playerRegionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <!-- Two full-width, detailed charts -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Average Playtime (Minutes) by Platform & Region</h5>
                        <canvas id="avgPlaytimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Performance & Technical Metrics: FPS vs. Ping</h5>
                        <canvas id="fpsPingScatterChart"></canvas>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Add your scripts at the end of the body -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Add Treemap plugin for Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        // Set global defaults for Chart.js for dark mode
        Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.2)';


        // Example script to create a chart
        var ctx = document.getElementById('feedbackChart').getContext('2d');
        var feedbackChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    label: 'Feedback counts',
                    data: [],
                    backgroundColor: [],
                    borderColor: 'rgba(255,255,255,0.8)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            // default empty, will be set when data is loaded
                            label: function(context) { return context.label + ': ' + context.parsed; }
                        }
                    }
                }
            }
        });

        var ctx = document.getElementById('playerRegionChart').getContext('2d');
        var playerRegionChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    label: '',
                    data: [],
                    backgroundColor: [],
                    borderColor: 'rgba(255,255,255,0.8)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            // default empty, will be set when data is loaded
                            label: function(context) { return context.label + ': ' + context.parsed; }
                        }
                    }
                }
            }
        });

        var ctx = document.getElementById('platformTimeChart').getContext('2d');
        var platformTimeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Player Count by Platform',
                    data: [],
                    backgroundColor: [],
                    borderColor: 'rgba(255,255,255,0.8)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Time in minutes'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Platforms'
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) { return context.label + ': ' + Math.round(context.parsed.y) + ' min'; }
                        }
                    }
                }
            }
        });

        var ctxAvgPlaytime = document.getElementById('avgPlaytimeChart').getContext('2d');
        var avgPlaytimeChart = new Chart(ctxAvgPlaytime, {
            type: 'bar',
            data: {
                labels: [], // Regions
                datasets: [] // Platforms
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += Math.round(context.parsed.y) + ' min';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Avg Playtime (minutes)'
                        }
                    },
                    x: {
                         title: {
                            display: true,
                            text: 'Region'
                        }
                    }
                }
            }
        });

        var ctxAdFunnel = document.getElementById('adFunnelChart').getContext('2d');
        var adFunnelChart = new Chart(ctxAdFunnel, {
            type: 'bar',
            data: {
                labels: [], // Steps: Impressions, Clicks, Purchases
                datasets: [{
                    label: 'Count',
                    data: [],
                    backgroundColor: ['#4dc9f6', '#f67019', '#f53794'],
                }]
            },
            options: {
                indexAxis: 'y', // This makes the bar chart horizontal
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.raw.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Total Count' }
                    }
                }
            }
        });

        var ctxDailyActive = document.getElementById('dailyActivePlayersChart').getContext('2d');
        var dailyActivePlayersChart = new Chart(ctxDailyActive, {
            type: 'line',
            data: {
                labels: [], // Dates
                datasets: [{
                    label: 'Unique Players',
                    data: [],
                    fill: true,
                    borderColor: '#537bc4',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count of Players'
                        }
                    },
                    x: {
                        title: { display: true, text: 'Date' }
                    }
                }
            }
        });

        var ctxFpsPing = document.getElementById('fpsPingScatterChart').getContext('2d');
        var fpsPingScatterChart = new Chart(ctxFpsPing, {
            type: 'scatter',
            data: {
                datasets: [] // Will be populated with data per device model
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                return `${label}: (Ping: ${context.parsed.x}ms, FPS: ${context.parsed.y})`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Avg FPS'
                        }
                    },
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Avg Ping (ms)'
                        }
                    }
                }
            }
        });


        function fetchDataAndUpdateChart() {
            Papa.parse('data.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    var rows = results.data.filter(r => r && Object.values(r).some(v => v !== ''));

                    if (rows.length === 0) {
                        console.warn('No data rows found in CSV.');
                        return;
                    }

                    // Try to find a header that looks like "feedback category" (case-insensitive)
                    var headerFields = (results.meta && results.meta.fields) || Object.keys(rows[0]);
                    var feedbackKey = headerFields.find(h => /feedback/i.test(h)) || headerFields[0];
                    var regionKey = headerFields.find(h => /region/i.test(h)) || headerFields[1];
                    var platformKey = headerFields.find(h => /platform/i.test(h)) || headerFields[2];
                    var playtimeKey = headerFields.find(h => /playtimelast7d_minutes/i.test(h)) || headerFields[15];
                    var adImpressionsKey = headerFields.find(h => /AdImpressionsLast7d/i.test(h)) || headerFields[21];
                    var adClicksKey = headerFields.find(h => /AdClicksLast7d/i.test(h)) || headerFields[22];
                    var purchasesKey = headerFields.find(h => /PurchasesLast7d/i.test(h)) || headerFields[19];
                    var dateKey = headerFields.find(h => /snapshotdate/i.test(h)) || headerFields[0];
                    var pingKey = headerFields.find(h => /AvgPingMs/i.test(h)) || headerFields[25];
                    var fpsKey = headerFields.find(h => /AvgFPS/i.test(h)) || headerFields[26];
                    var deviceKey = headerFields.find(h => /DeviceModel/i.test(h)) || headerFields[11];
                    var spentKey = headerFields.find(h => /SpentLast7d_USD/i.test(h)) || headerFields[18];

                    // Aggregate counts per category
                    var counts = {};
                    rows.forEach(row => {
                        var raw = row[feedbackKey];
                        var cat = (raw || '').toString().trim();
                        if (!cat) cat = 'Unknown';
                        counts[cat] = (counts[cat] || 0) + 1;
                    });
                    
                    // Aggregate counts per region
                    var regionData = {};
                    rows.forEach(row => {
                        var raw = row[regionKey];
                        var region = (raw || '').toString().trim();
                        if (!region) region = 'Unknown';
                        regionData[region] = (regionData[region] || 0) + 1;
                    });

                    //Aggregate counts per platform
                    var platformData = {};
                    rows.forEach(row => {
                        var raw = row[platformKey];
                        var platform = (raw || '').toString().trim();
                        if (!platform) platform = 'Unknown';
                        platformData[platform] = (platformData[platform] || 0) + 1;
                    });

                    var originalLabels = Object.keys(counts);
                    var data = originalLabels.map(l => counts[l]);
                    
                    var total = data.reduce((s, v) => s + v, 0);
                    // percentages rounded to whole numbers
                    var percentages = data.map(v => total > 0 ? Math.round((v / total) * 100) : 0);

                    // build display labels that include the percent
                    var labelsWithPct = originalLabels.map((l, i) => `${l} (${percentages[i]}%)`);

                    // Define a color palette for the charts
                    var palette = [
                        '#4dc9f6', '#f67019', '#f53794', '#537bc4',
                        '#acc236', '#166a8f', '#00a950', '#58595b', '#8549ba'
                    ];

                    // Define specific colors for the feedback chart based on category
                    const feedbackColorMap = {
                        'positive': '#28a745', // A nice green
                        'neutral': '#007bff',  // A standard blue
                        'negative': '#dc3545', // A clear red
                        'Unknown': '#6c757d'   // A grey for any other cases
                    };
                    var bg = originalLabels.map(label => feedbackColorMap[label] || palette[Math.floor(Math.random() * palette.length)]);

                    // Update chart data and labels
                    feedbackChart.data.labels = labelsWithPct;
                    // Set the data for the feedback chart
                    feedbackChart.data.datasets[0].data = data;
                     // Set the background colors for the feedback chart
                    feedbackChart.data.datasets[0].backgroundColor = bg;                    

                    // Calculate percentages for Player Region Chart
                    var regionLabels = Object.keys(regionData);
                    var regionCounts = Object.values(regionData);
                    var regionTotal = regionCounts.reduce((s, v) => s + v, 0);
                    var regionPercentages = regionCounts.map(v => regionTotal > 0 ? Math.round((v / regionTotal) * 100) : 0);
                    var regionLabelsWithPct = regionLabels.map((l, i) => `${l} (${regionPercentages[i]}%)`);

                    // Update playerRegionChart labels to include percentages
                    playerRegionChart.data.labels = regionLabelsWithPct;
                    // Set the data for the player region chart
                    playerRegionChart.data.datasets[0].data = regionCounts;
                    // Set the background colors for the player region chart
                    playerRegionChart.data.datasets[0].backgroundColor = Object.keys(regionData).map((_, i) => palette[i % palette.length]);

                    // --- Logic for Platform Avg Time Chart ---
                    const platformAvgTimeData = {}; // { platform: { total: 0, count: 0 } }
                    const timePlatforms = new Set();
                    rows.forEach(row => {
                        const platform = row[platformKey];
                        const playtime = parseFloat(row[playtimeKey]);
                        if (platform && !isNaN(playtime)) {
                            timePlatforms.add(platform);
                            if (!platformAvgTimeData[platform]) platformAvgTimeData[platform] = { total: 0, count: 0 };
                            platformAvgTimeData[platform].total += playtime;
                            platformAvgTimeData[platform].count++;
                        }
                    });
                    const sortedTimePlatforms = Array.from(timePlatforms).sort();
                    const avgTimeData = sortedTimePlatforms.map(p => platformAvgTimeData[p].count > 0 ? platformAvgTimeData[p].total / platformAvgTimeData[p].count : 0);
                    platformTimeChart.data.labels = sortedTimePlatforms;
                    platformTimeChart.data.datasets[0].data = avgTimeData;
                    platformTimeChart.data.datasets[0].backgroundColor = sortedTimePlatforms.map((_, i) => palette[i % palette.length]);

                    // --- New Chart Logic: Average Playtime by Platform & Region ---
                    const playtimeData = {}; // { region: { platform: { total: 0, count: 0 } } }
                    const allPlatforms = new Set();
                    const allRegions = new Set();

                    rows.forEach(row => {
                        const region = row[regionKey];
                        const platform = row[platformKey];
                        const playtime = parseFloat(row[playtimeKey]);

                        if (region && platform && !isNaN(playtime)) {
                            allRegions.add(region);
                            allPlatforms.add(platform);

                            if (!playtimeData[region]) playtimeData[region] = {};
                            if (!playtimeData[region][platform]) playtimeData[region][platform] = { total: 0, count: 0 };

                            playtimeData[region][platform].total += playtime;
                            playtimeData[region][platform].count++;
                        }
                    });

                    const sortedRegions = Array.from(allRegions).sort();
                    const sortedPlatforms = Array.from(allPlatforms).sort();

                    const datasets = sortedPlatforms.map((platform, i) => {
                        const data = sortedRegions.map(region => {
                            const regionPlatformData = playtimeData[region] && playtimeData[region][platform];
                            if (regionPlatformData && regionPlatformData.count > 0) {
                                return regionPlatformData.total / regionPlatformData.count;
                            }
                            return 0; // No data for this combination
                        });

                        return {
                            label: platform,
                            data: data,
                            backgroundColor: palette[i % palette.length],
                            borderColor: palette[i % palette.length],
                            borderWidth: 1
                        };
                    });

                    avgPlaytimeChart.data.labels = sortedRegions;
                    avgPlaytimeChart.data.datasets = datasets;

                    // --- New Chart Logic: Ad Engagement Funnel ---
                    let totalImpressions = 0;
                    let totalClicks = 0;
                    let totalPurchases = 0;

                    rows.forEach(row => {
                        totalImpressions += parseInt(row[adImpressionsKey], 10) || 0;
                        totalClicks += parseInt(row[adClicksKey], 10) || 0;
                        totalPurchases += parseInt(row[purchasesKey], 10) || 0;
                    });

                    adFunnelChart.data.labels = ['Ad Impressions', 'Ad Clicks', 'Purchases'];
                    adFunnelChart.data.datasets[0].data = [totalImpressions, totalClicks, totalPurchases];

                    // --- New Chart Logic: Daily Active Players ---
                    const dailyPlayers = {}; // { date: count }
                    rows.forEach(row => {
                        const date = row[dateKey];
                        if (date) {
                            dailyPlayers[date] = (dailyPlayers[date] || 0) + 1;
                        }
                    });

                    const sortedDates = Object.keys(dailyPlayers).sort();
                    const playerCountByDay = sortedDates.map(date => dailyPlayers[date]);
                    dailyActivePlayersChart.data.labels = sortedDates;
                    dailyActivePlayersChart.data.datasets[0].data = playerCountByDay;

                    // --- New Chart Logic: FPS vs Ping Scatter Plot ---
                    const scatterDataByDevice = {};

                    rows.forEach(row => {
                        const device = row[deviceKey] || 'Unknown';
                        const ping = parseFloat(row[pingKey]);
                        const fps = parseFloat(row[fpsKey]);

                        if (!isNaN(ping) && !isNaN(fps)) {
                            if (!scatterDataByDevice[device]) {
                                scatterDataByDevice[device] = [];
                            }
                            scatterDataByDevice[device].push({ x: ping, y: fps });
                        }
                    });

                    const scatterDatasets = Object.keys(scatterDataByDevice).map((device, i) => {
                        return {
                            label: device,
                            data: scatterDataByDevice[device],
                            backgroundColor: palette[i % palette.length],
                            // Optional: Add a border to make points more visible
                            // borderColor: 'rgba(0,0,0,0.5)',
                            // borderWidth: 1,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        };
                    });
                    fpsPingScatterChart.data.datasets = scatterDatasets;

                    // Update tooltip to show original label, count and percent
                    feedbackChart.options.plugins.tooltip.callbacks.label = function(context) {
                        var idx = context.dataIndex;
                        var label = originalLabels[idx] || context.label;
                        var value = context.dataset.data[idx];
                        var pct = percentages[idx];
                        return label + ': ' + value + ' (' + pct + '%)';
                    };

                    // Update tooltip for Player Region chart to show count and percent
                    playerRegionChart.options.plugins.tooltip.callbacks.label = function(context) {
                        var idx = context.dataIndex;
                        var label = regionLabels[idx] || context.label;
                        var value = context.dataset.data[idx];
                        var pct = regionPercentages[idx];
                        return label + ': ' + value + ' (' + pct + '%)';
                    };

                    // Finally, update the charts to reflect the new data
                    feedbackChart.update();
                    playerRegionChart.update();
                    platformTimeChart.update();
                    avgPlaytimeChart.update();
                    adFunnelChart.update();
                    dailyActivePlayersChart.update();
                    fpsPingScatterChart.update();
                    
                },
                error: function(error) {
                    console.error('Error fetching or parsing data:', error);
                }
            });
        }

        // Call the function to fetch data and update chart
        fetchDataAndUpdateChart();
    </script>
</body>
</html>